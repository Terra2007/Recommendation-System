# 연관규칙분석 Apriori Algorithm

연관규칙분석이란 어떤 두 아이템 집합이 번번히 발생하는가를 알려주는 규칙을 생성하는 알고리즘입니다.

경영학에서 장바구니 분석으로 널리 알려져 있는 방법론입니다, 소비자들의 구매이력 데이터를 토대로

"X 아이템을 구매하는 고객들은 Y 아이템 역시 구매할 가능성이 높다"는 식의 결론을 내는 알고리즘입니다.

인터넷 쇼핑을 할 때 어떤 상품을 고르면 그 상품을 구매한 사람들이 선택한 다른 상품을 제안해준다던지 하는 컨텐츠 기반 추천의 기본이 되는 방법론입니다.



다음과 같은 매출 표가 있다고 가정해봅시다.

|  ID  |          Items           |
| :--: | :----------------------: |
|  1   |    달걀, 라면, 참치캔    |
|  2   |        라면, 햇반        |
|  3   |        라면, 콜라        |
|  4   |     달걀, 라면, 햇반     |
|  5   |        달걀, 콜라        |
|  6   |        라면, 콜라        |
|  7   |        라면, 햇반        |
|  8   | 달걀, 라면, 콜라, 참치캔 |
|  9   |     달걀, 라면, 콜라     |
|  10  |           양파           |





용어 부터 정의해보자면. 조건절은 위 예시의 규칙에서 '만일 ~라면'에 해당하는 부분입니다. 결과절은 그 뒷부분에 해당하는 내용합니다. 아이템 집합이란 조건절 또는 결과절을 구성하는 아이템들의 집합입니다.

'달걀을 구매하는 사람들은 라면도 함께 산다'를 본다면, '달걀 구매'가 조건절, '라면 구매'가 결과절이며 각각의 조건절 아이템 집합과 결과절 아이템 집합은 말 그대로 집합, 여러개 아이템이 들어가도 되지만 상호배반이어야 합니다. 다시 말해 조건절에 달걀이 들어가 있다면 결과절에는 달걀이 포함되어서는 안된다는 뜻입니다.



그렇다면 무수히 많은 규칙 가운데서도 좋은 규칙이란 무엇일까요? 규칙의 효용성을 드러내주는 지표는 크게 지지도와 신뢰도, 향상도가 있습니다. 빈발아이템 집합을 판별하는 데 쓰는 '지지도'는 아래와 같이 '조건절이 일어날 확률'로 정의 됩니다.
$$
For\; the\; rule\;A \rightarrow B,\\
support(A) = P(A)
$$
아이템 집합 간의 연관성 강도를 측정하는 데 쓰는 신뢰도는 아래와 같이 조건절이 주어졌을 때 결과절이 일어날 조건부확률로 정의됩니다.
$$
confidence(A \rightarrow B) = {P(A, B)\over P(A)}
$$
생성된 규칙이 실제 효용가치가 있는지를 판별하는데 사용되는 향상도는 아래와 같이 조건절과 결과절이 서로 독립일 때와 비교해 두 사건이 동시에 얼마나 발생하는지를 비율로 나타납니다.

향상도가 1이라면 조건절과 결과절은 서로 독립임을 뜻합니다. 규칙 사이에 유의미한 연관성이 없다는 것입니다. 향상도가 2라면 두 사건이 독립이라는 걸 가정했을때 대비 2배로 긍정적인 연관관계를 나타냅니다.
$$
lift(A \rightarrow B) = {P(A, B)\over P(A) \; \cdot \; P(B)}
$$
규칙의 효용성은 지지도, 신뢰도, 향상도 세 가지를 모두 반영해 평가하게 됩니다. 임의의 규칙1이 규칙2보다 효과적인 규칙이라는 이야기를 하려면 세 지표 모두 클 경우에만 그렇다고 결론을 내릴 수 있게 된다는 이야기입니다.



가능한 모든 경우의 수를 탐색하여 지지도, 신뢰도, 향상도가 높은 규칙들을 찾아내는 방식이 가장 이상적일 겁니다. 하지만 아이템 수가 증가할수록 계산에 소요되는 시간이 기하급수적으로 증가하게 됩니다 (아이템이 n개 일때 탐색해야할 경우의 수 : n * (n - 1))이 때문에 빈발 집합만을 고려하여 연관 규칙을 생성하는 Apriori algorithm 이 제안되었습니다.



아이템 집합 {A}의 지지도, 즉 P(A)가 0.1로 나타났다고 가정해봅시다. 그렇다면 아이템 집합 {A, B}의 지지도는 아무리 높아도 0.1을 넘지 못할 것 입니다. 왜냐하면 A가 단독으로 등장할 확률인 P(A)는 A와 B가 동시에 나타날 확률인 P(A, B)보다는 크거나 같을 것이기 때문입니다. 이 때 {A, B}는 {A}, {B}의 초월집합이라고 부릅니다.



만약 임의의 아이템 집합의 지지도가 일정 기준을 넘지 못한다면 해당 아이템 집합의 초월집합의 지지도는 그 기준보다 명백히 더 작을 것이고, 그렇기 때문에 유용한 규칙으로 인정받을 수가 없게 됩니다. 최소지지도 요건을 만족하지 못하는 아이템집합의 규칙들은 애당초 계산할 필요가 없다는 이야기입니다.

![img](http://i.imgur.com/tncW2Gn.png)

만일 아이템 집합 {A, B}의 지지도가 사용자가 정한 최소 지지도 요건을 충족시키지 못했을 때 {A, B}는 물론 {A, B}의 초월집합인 {A, B, C}, {A, B, D} 등 8가지 경우의 수를 계산에서 제외하게 됩니다. 이로써 계산 효율성을 달성하는 셈입니다.